# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible-community/schemas/main/f/ansible-tasks.json
- block:
    - include_tasks: arch.yml
      when: ansible_os_family == "Archlinux"
      tags:
        - arch

    - name: Install base packages
      when: ansible_os_family == "Archlinux"
      kewlfft.aur.aur:
        state: present
        name:
          - base-devel
          - curl
          - dnsutils # host(1), etc.
          - git
          - inetutils # hostname(1), etc.
          - jq
          - lsof
          - man-pages
          - openssh # SSH client and server
          - parallel
          - polkit
          - rsync
          - tmux

          # Shell
          - zsh
          - zsh-completions
          - zsh-history-substring-search
          - zsh-syntax-highlighting

          # Filesystems
          - nfs-utils
          - ntfs-3g
          - exfat-utils
          - btrfs-progs

    - include_tasks: grub_theme.yml

    - name: "Enable services"
      become: true
      when: not inside_docker
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - sshd
        - bluetooth
        - systemd-timesyncd

    - when: not inside_docker
      block:
        - name: Check timedatectl
          command: timedatectl show
          changed_when: false
          register: timedatectl_result

        - name: Set timezone
          become: true
          command: timedatectl set-timezone Europe/Stockholm
          when: "'Europe/Stockholm' not in timedatectl_result.stdout"

        - name: Enable ntp
          become: true
          command: timedatectl set-ntp true
          when: "'NTP=yes' not in timedatectl_result.stdout"

    - name: Ensure en_US.UTF-8 locale
      become: true
      community.general.locale_gen:
        name: en_US.UTF-8

    - name: Ensure sv_SE.UTF-8 locale
      become: true
      # Arch linux Docker image only has en_US.UTF-8 locale available to keep
      # docker image size down. Pacman does not have other locales available.
      when: not inside_docker
      community.general.locale_gen:
        name: sv_SE.UTF-8
