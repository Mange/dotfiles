#!/usr/bin/env bash
# Runs in the background and keeps track of when the user's session is
# locked/unlocked. When a locking event happens the appropriate script runs.

# Determine current session path
# Get the current user's sessions, then grep out the first one.
# Example reply:
# method return time=1535970362.689864 sender=:1.17 -> destination=:1.2751 serial=710 reply_serial=2
#    variant       array [
#          struct {
#             string "2"
#             object path "/org/freedesktop/login1/session/_32"
#          }
#       ]
session_path=$(
  dbus-send \
    --system \
    --print-reply \
    --type=method_call \
    --dest='org.freedesktop.login1' \
    "/org/freedesktop/login1/user/_$(id -u)" \
    org.freedesktop.DBus.Properties.Get \
    string:org.freedesktop.login1.User \
    string:Sessions |
  grep -oE "(/org/freedesktop/login1/session/_[0-9]+)" |
  head -n1
)

if [[ -z $session_path ]]; then
  echo "Could not determine your session path!" > /dev/stderr
  exit 1
fi

interface=org.freedesktop.login1.Session
matcher="type=signal,path=${session_path},interface=${interface}"

lock_script="${XDG_CONFIG_HOME}/locking-monitor/on_lock"
unlock_script="${XDG_CONFIG_HOME}/locking-monitor/on_unlock"

# Emits signals that look like this: (Line breaks added for readability)
# signal time=1530687734.989902 sender=:1.3 ->
#    destination=(null destination)
#    serial=1403
#    path=/org/freedesktop/login1/session/c2;
#    interface=org.freedesktop.login1.Session;
#    member=Lock
dbus-monitor --system "$matcher" 2>/dev/null |
  # Extract the "member=SomeMember" part as "SomeMember"
  # Grep defaults to buffering up all output until the input stream is closed
  # when grep's stdout isn't a terminal, --line-buffered goes back to the same
  # line-by-line behavior that it uses when the output is a terminal.
  grep --line-buffered -oP '(?<=member=)\w+' |
  while read -r member; do
    case "$member" in
      Lock)
        if [[ -x "$lock_script" ]]; then
          echo "$(date)	Running $lock_script"
          "$lock_script"
        fi
        ;;
      Unlock)
        if [[ -x "$unlock_script" ]]; then
          echo "$(date)	Running $unlock_script"
          "$unlock_script"
        fi
        ;;
      *)
        # Do nothing on unexpected signals
    esac
  done
