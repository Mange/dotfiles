#!/usr/bin/env bash
set -e

force=no
action=

while [[ $# -gt 0 ]]; do
  case "$1" in
  logout)
    action="logout"
    shift
    ;;
  poweroff)
    action="poweroff"
    shift
    ;;
  reboot)
    action="reboot"
    shift
    ;;
  --force)
    force=yes
    shift
    ;;
  --help)
    echo "USAGE: $0 [logout|poweroff|reboot] [--force]"
    exit 0
    ;;
  *)
    echo "Unknown argument(s): $*" >&2
    exit 1
    ;;
  esac
done

if [[ -z "$action" ]]; then
  force=yes
  action=$(echo -e "logout\\npoweroff\\nreboot\\ncancel" | rofi -dmenu -p "Quit?" -i -no-custom || true)
  if [[ $action == cancel ]] || [[ -z "$action" ]]; then
    exit 0
  fi
fi

if [[ $force == no ]]; then
  answer=$(echo -e "No, I made a mistake.\\nYes, ${action}." | rofi -dmenu -p "Really ${action}?" -i -no-custom || true)
  if [[ $answer != Yes* ]]; then
    exit 0
  fi
fi

notify_opts=(--app-name System --urgency critical)

if icon=$(find-icon-file system-log-out); then
  notify_opts+=(--icon "$icon")
fi

# Show notification so user knows that the system is shutting down...
notify-send "${notify_opts[@]}" "Quitting" \
  "Currently shutting down apps and logging out."

# Unmount all removable storage
udiskie-umount --all

# Shut down Firefox without using signals as it does not properly support them yet
hash wmctrl 2>/dev/null >/dev/null && wmctrl -c firefox

# Shut down all my apps
hash graceful-shutdown 2>/dev/null >/dev/null &&
  graceful-shutdown \
    --mine --whole-command --wait-time 15.0 \
    <"$XDG_CONFIG_HOME/graceful-shutdown/logout"

case "$action" in
logout)
  case "${DESKTOP_SESSION:-${XDG_CURRENT_DESKTOP}}" in
  awesome)
    awesome-client "awesome.quit()"
    ;;
  Hyprland)
    hyprctl dispatch exit
    ;;
  *)
    notify-send "${notify_opts[@]}" "Quitting" \
      "Desktop session is unsupported: \"${DESKTOP_SESSION}\""
    ;;
  esac
  ;;
poweroff)
  exec systemctl poweroff
  ;;
reboot)
  exec systemctl reboot
  ;;
esac
