#!/usr/bin/env bash
# Run vifm with Ãœberzug FIFO wrapped around it to enable image previews.

export FIFO_UEBERZUG="/tmp/vifm-ueberzug-${PPID}"

function cleanup {
    rm "$FIFO_UEBERZUG" 2>/dev/null
    pkill -P $$ 2>/dev/null
}

original="$(which --all vifm | grep -v "$0" | head -n 1)"
if [[ -z "$original" ]]; then
  echo "Could not find either vifm installed on this machine." >&2
  exit 1
else
  rm "$FIFO_UEBERZUG" 2>/dev/null
  mkfifo "$FIFO_UEBERZUG"
  trap cleanup EXIT
  tail --follow "$FIFO_UEBERZUG" | ueberzug layer --silent --parser bash &

  "$original" "$@"
  cleanup
fi
