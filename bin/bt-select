#!/usr/bin/env bash

function icon() {
  local device_id="$1"
  local info
  local icon
  info=$(echo "info ${device_id}" | bluetoothctl)

  # Headsets use the icon "audio-card", but I want a headset. Headsets lists a
  # "Headset" profile on them, though.
  # Phones also have the Headset profile, but that should still get the phone
  # icon.
  if [[ $info == *Headset* ]] && [[ $info != *Icon:\ phone* ]]; then
    echo ""
    return
  fi

  # My AnnePro keyboard does not have anything generally identifiable, so let's
  # match on the name instead.
  if [[ $info == *AnnePro* ]]; then
    echo ""
    return
  fi

  icon=$(echo "$info" | grep "Icon" | awk '{ print $2 }')
  case "$icon" in
    phone)
      echo ""
      ;;
    audio-card)
      echo "蓼"
      ;;
    *)
      echo ""
      ;;
  esac
}

selected_device=$(
  selections=()
  connected_indices=()
  ids=()
  index=0

  mapfile -t devices < <(
    echo "paired-devices" | bluetoothctl | grep "Device " | sort
  )

  # bluetoothctl emits other junk on stdout; grep for lines we want
  for device in "${devices[@]}"; do
    id=$(echo "$device" | awk '{ print $2 }')
    name=$(echo "$device" | cut -d " " -f 3-)

    info=$(echo "info $id" | bluetoothctl)

    connected=""
    if [[ $(echo "$info" | grep "Connected: " | awk '{ print $2 }') == "yes" ]]; then
      connected=" (Connected)"
      connected_indices+=("-a" "$index")
    fi

    ids+=("$id")
    selections+=("$(icon "$id") ${name}${connected}")
    index=$((index+1))
  done

  selected_index=$(
    printf '%s\n' "${selections[@]}" | \
      rofi -dmenu -p "Select device" -i -no-custom -format i "${connected_indices[@]}"
  )

  if [[ -n $selected_index ]]; then
    echo "${ids[$selected_index]}"
  fi
)

if [[ -n $selected_device ]]; then
  selected_name="${selected_device/ \[*}"
  selected_id=$(echo "$selected_device" | grep -oE '\[[^]]+\]' | tr -d '[]')

  if echo "$selected_device" | grep -q "(Connected)"; then
    echo "disconnect $selected_id" | bluetoothctl
    notify-send \
      --app-name=bt-select \
      --icon=/usr/share/icons/Adwaita/48x48/status/bluetooth-disabled-symbolic.symbolic.png \
      --category=device.removed \
      "Disconnecting" \
      "Disconnecting from ${selected_name}"
  else
    echo "connect $selected_id" | bluetoothctl
    notify-send \
      --app-name=bt-select \
      --icon=/usr/share/icons/Adwaita/48x48/status/bluetooth-active-symbolic.symbolic.png \
      --category=device.added \
      "Connecting" \
      "Connecting to ${selected_name}"
  fi
fi
