#!/bin/bash

set -e

if [[ $1 == "--help" ]]; then
  echo "USAGE: $0 [--force]"
  exit 0
fi

force=no

if [[ $1 == "--force" ]]; then
  force=yes
elif [[ $# -gt 0 ]]; then
  echo "Unknown argument(s): $*" > /dev/stderr
  exit 1
fi

if [[ $force == no ]]; then
  answer=$(echo -e "No, I made a mistake.\\nYes, log out." | rofi -dmenu -p "Really log out?" -i -no-custom || true)
  if [[ $answer != Yes* ]]; then
    exit 0
  fi
fi

# Show notification so user knows that the system is shutting down...
notify-send \
  --app-name System \
  --icon /usr/share/icons/gnome/256x256/actions/system-log-out.png \
  --urgency critical \
  "Logging out" \
  "Currently shutting down apps and quitting i3."

# Unmount all removable storage
udiskie-umount --all

# Shut down all my apps
graceful-shutdown --mine --wait-time 10.0 < "$XDG_CONFIG_HOME/graceful-shutdown/logout"

# Shut down i3; essentially logging me out
exec i3-msg exit
