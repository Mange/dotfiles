# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible-community/schemas/main/f/ansible-tasks.json
- block:
    - name: Install repo symlink
      file:
        src: "{{ '.' | realpath }}"
        dest: "{{ xdg_config_home }}/dotfiles"
        state: link
        force: true
        follow: false

    - name: Ensure XDG directories exist
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ xdg_config_home }}"
        - "{{ xdg_data_home }}"
        - "{{ xdg_cache_home }}"
        - "{{ xdg_bin }}"

    - name: Get .config dotfiles
      find:
        paths: "../config"
        depth: no
        file_type: any
        follow: no
        hidden: yes
      register: dotfiles_config

    - name: Get .local/share dotfiles
      find:
        paths: "../data"
        depth: no
        file_type: any
        follow: no
        hidden: yes
      register: dotfiles_data

    - name: Get .local/bin files
      find:
        paths: "../bin"
        depth: no
        file_type: any
        follow: no
        hidden: yes
      register: dotfiles_bin

    - name: Get snowflake dotfiles
      find:
        paths: "../snowflakes"
        depth: no
        file_type: any
        follow: no
        hidden: yes
      register: dotfiles_snowflakes

    - name: Install .config dotfiles
      file:
        src: "dotfiles/config/{{ item }}"
        dest: "{{ xdg_config_home }}/{{ item }}"
        state: link
      loop: "{{ dotfiles_config.files | map(attribute='path') | map('basename') }}"

    - name: Install .local/share dotfiles
      file:
        src: "{{ xdg_config_home }}/dotfiles/data/{{ item }}"
        dest: "{{ xdg_data_home }}/{{ item }}"
        state: link
      loop: "{{ dotfiles_data.files | map(attribute='path') | map('basename') }}"

    - name: Install .local/bin dotfiles
      file:
        src: "{{ xdg_config_home }}/dotfiles/bin/{{ item }}"
        dest: "{{ xdg_bin }}/{{ item }}"
        state: link
      loop: "{{ dotfiles_bin.files | map(attribute='path') | map('basename') }}"

    - name: Install snowflakes
      file:
        src: "{{ xdg_config_home }}/dotfiles/snowflakes/{{ item }}"
        dest: "{{ user_home }}/.{{ item }}"
        state: link
        force: true
      loop: "{{ dotfiles_snowflakes.files | map(attribute='path') | map('basename') }}"
