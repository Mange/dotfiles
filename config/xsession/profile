#!/usr/bin/env bash
shopt -s nullglob

# shellcheck source=/dev/null
source "${XDG_CONFIG_HOME:-${HOME}/.config}/shells/common"

# shellcheck source=/dev/null
source "${XDG_CONFIG_HOME}/shells/enable-rvm"

# Tell KDE apps to load theme using qt5ct
export QT_QPA_PLATFORMTHEME=qt5ct

eval "$(/usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)"
export SSH_AUTH_SOCK
export GNOME_KEYRING_CONTROL

# Disable HiDPI
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export GDK_SCALE=1
Xrdb -merge <(echo Xft.dpi: 96)
xrandr --dpi 96

# Try to fix the screen setup before starting i3
# This might help set sane defaults for programs starting up. Generally, I
# might have a single HiDPI display connected but it might be turned off. That
# does not mean that I want HiDPI on all other screens; I want it on no
# screens.
# Autorandr sets the DPI too, which should enable/disable autoscaling for
# some apps.
# If autorandr fails, fall back on running normal xrandr --auto.
autorandr --change --default horizontal || xrandr --auto

# Awesome WM's early autostart stuff
if [[ "$DESKTOP_SESSION" == "awesome" ]]; then
  # Compositor and graphics
  compton --config ~/.config/compton/compton.conf
  flashfocus
  systemctl --user start redshift

  # Keyboard, screens, host-specific, etc.
  ~/.local/bin/dynamic-startup

  # Daemons
  wm-start parcellite --no-icon # Clipboard manager
  wm-start syncthing-gtk --minimized
  wm-start udiskie --no-automount --smart-tray # Device mounter
  wm-start unclutter # Hide mouse cursor when not in use
fi
